{% extends "layout.html" %}
{% block content %}





<script type=text/javascript>

  function showWaiting(show){
    if (show){
        $('#divWaiting').show();
    } else {
        $('#divWaiting').hide();
    }
    
  }

  function dateSelected() {
      var selectedDate = $("#ddlDates option:selected").val();
      if (selectedDate != '0'){

        $('#no-tweets').hide();
        $("#divQuery").hide();
        var ddlHeadlines = $("#ddlHeadlines");

        $.getJSON($SCRIPT_ROOT + '/_ddlDates_handler', {
            date: selectedDate
        }, function(data) {
            ddlHeadlines.html('');

            $.each(data.headlines, function(key, val){
                ddlHeadlines.append('<option value="' + val.id + '">' + val.text + '</option>')
            })
        });

      }
    }
 

  $(function() {
    $('#btnGetSargs').bind('click', function() {
      $("#divD3").hide();
      showWaiting(true);
      $.getJSON($SCRIPT_ROOT + '/_btnGetSargs_handler', {
        id: $("#ddlHeadlines option:selected").val(),
        text: $("#ddlHeadlines option:selected").text()
      }, function(data) {
        $("#divQuery").show();
        $("#txtSargs").val(data.result);
        showWaiting(false);
      });
      return false;
    });
  });

  $(function() {
    $('#btnQuery').bind('click', function() {
      showWaiting(true);
      $('#no-tweets').hide();
      $.getJSON($SCRIPT_ROOT + '/_btnQuery_handler', {
        id: $("#ddlHeadlines option:selected").val(),
        text: $("#txtSargs").val(),
        headline: $("#ddlHeadlines option:selected").text()
      }, function(data) {
        showWaiting(false);
        if (data.result){
            $("#tweet-count").text("(" + data.tweet_count + " tweets analyzed)")
            makeGraph(data.result, data.headline_score, data.scale);
        } else {
            $('#no-tweets').show();
        }
      });
      return false;
    });
  });  

  // ---------------------- D3 ------------------------//
  function makeGraph(data, headline_score, scale){

    $("#divD3").show();
    $("#d3-canvas").empty();

    var hasNegSentiment = Math.min.apply(Math, data.map(function(d){return d.sentiment;})) < 0;
    var minX = Math.min.apply(Math, data.map(function(d){return d.time_period;}))

    // Set the dimensions of the canvas / graph
    var margin = {top: 30, right: 20, bottom: 30, left: 50},
        width = 1000 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    
    // Set the ranges
    var x = d3.scale.linear().range([0, width]);
    var y = d3.scale.linear().range([height, 0]);

    // Define the axes
    var xAxis = d3.svg.axis().scale(x).orient("bottom").ticks(10);

    var yAxis = d3.svg.axis().scale(y).orient("left").ticks(5);


    // Define the line
    var valueline = d3.svg.line()
        .x(function(d) { return x(d.time_period); })
        .y(function(d) { return y(d.sentiment); });

    // Adds the svg canvas
    var svg = d3.select("#d3-canvas")
        .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
        .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // Derive coordinates for headline score
    //var headline_score_y = y(headline_score);

    // Scale the range of the data
    x.domain(d3.extent(data, function(d) { return d.time_period; }));
    y.domain(d3.extent(data, function(d) { return d.sentiment; }));

    // Adjust graph title
    $('#graph-title').text('average twitter sentiment since news hit (by ' + scale.slice(0, -1) + ')');

    // Add the valueline path.
    svg.append("path")
        .attr("class", "line")
        .attr("d", valueline(data));

    // Add the X Axis
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    // Add the Y Axis
    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis);

    svg.append("text")
        .attr("class", "x label")
        .attr("text-anchor", "end")
        .attr("x", width)
        .attr("y", height - 6)
        .text(scale + " since the news");

    svg.append("text")
        .attr("class", "y label")
        .attr("text-anchor", "end")
        .attr("y", 6)
        .attr("dy", "1em")
        .attr("transform", "rotate(-90)")
        .text("sentiment");

    svg.append("line")
        .attr("x1", x(minX))
        .attr("y1", y(headline_score))
        .attr("x2", width)
        .attr("y2", y(headline_score))
        .attr("stroke-width", 2)
        .attr("stroke", "maroon")
        .attr("stroke-dasharray", "10,10");

    if (hasNegSentiment){
        svg.append("line")
            .attr("x1", x(minX))
            .attr("y1", y(0))
            .attr("x2", width)
            .attr("y2", y(0))
            .attr("stroke-width", 1)
            .attr("stroke", "grey");
    }
  }

</script>

<div class="container-fluid">

    <h1>twitter news reaction</h1>
    <br/>
    <div class="row">
        <div class="col-md-2">
            <select id="ddlDates" class="form-control" onchange="dateSelected();">
                <option class="default" value="0"> < choose date > </option>
                {% for d in dates %}
                    <option value="{{ d }}">{{ d }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6">
            <select id="ddlHeadlines" class="form-control">
            </select>
        </div>
        <div class="col-md-2">
            <input id="btnGetSargs" type="submit" value="Extract Search Terms" class="btn btn-default"></input>
        </div>        
    </div>
    <br/>
    <div class="row" id="divQuery" style="display: none">
        <div class="col-md-6">
            <input type="text" id="txtSargs" class="form-control"></input>
        </div>
        <div class="col-md-2">
            <input id="btnQuery" type="submit" value="Query Twitter" class="btn btn-default"></input>
        </div>         
    </div>
    <br/>
    <h4 id="no-tweets" style="display: none">No tweets matched the search</h4>
    <div id="divD3" style="display: none">
        <div class="row">
            <div class="col-md-offset-1 col-md-11">
                <h3 id="graph-title"></h3>
                <h5 id="tweet-count"></h5>
            </div>    
        </div>
        <div id="d3-canvas"></div>
    </div>
    <div id="divWaiting" class="content-center" style="display: none">
        <img src="../static/img/waiting.gif" id="imgWaiting"></img>
    </div>
</div>
{% endblock %}